<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STOMP WebSocket í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>STOMP WebSocket í…ŒìŠ¤íŠ¸</h2>

<label>ì±„ë„ ID:</label>
<input type="text" id="documentId" value="room1">
<br><br>

<button onclick="connect()">ğŸ”— STOMP ì—°ê²°</button>
<button onclick="disconnect()">âŒ ì—°ê²° ì¢…ë£Œ</button>
<br><br>

<button onclick="subscribe()">ğŸ‘€ ì±„ë„ êµ¬ë…</button>
<button onclick="unsubscribe()">ğŸš« êµ¬ë… ì·¨ì†Œ</button>
<br><br>

<button onclick="loadDocument()">ğŸ“„ ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
<br><br>

<label>ë¬¸ì„œ í¸ì§‘:</label>
<div id="editor"
     contenteditable="true"
     style="border: 1px solid #ccc; width: 400px; height: 200px; padding: 10px; overflow-y: auto;">
</div>
<button onclick="sendMessage()">ğŸ“© ë©”ì‹œì§€ ì „ì†¡</button>

<h3>ğŸ“© ë©”ì‹œì§€ ë¡œê·¸:</h3>
<div id="messageLog" style="border: 1px solid #ccc; padding: 10px; width: 400px; height: 200px; overflow-y: scroll;"></div>

<script>
  let stompClient = null;
  let subscription = null;

  // âœ… JWT í† í°
  const token = "Bearer eyJhbGciOiJIUzI1NiJ9.eyJjYXRlZ29yeSI6ImFjY2VzcyIsImVtYWlsIjoicXdlMTIzQG5hdmVyLmNvbSIsInJvbGUiOiJST0xFX01BTkFHRVIiLCJpYXQiOjE3NTU3NzY2NTQsImV4cCI6MTc1NTc3NzU1NH0.HfilkYMysVkJn47eCkiS3HjJn4WRAKYPtmJvZYamisE";

  function logMessage(message) {
    const logDiv = document.getElementById("messageLog");
    logDiv.innerHTML += `<p>${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function connect() {
    const socket = new SockJS("https://docktalk.co.kr/api/socket/doc/wss");
    const socket2 = new SockJS("https://docktalk.co.kr/api/socket/notification/wss");
    stompClient = Stomp.over(socket);
    stompClient2 = Stomp.over(socket2);
    console.log(token);

    stompClient.connect(
      { Authorization: token },
      function (frame) {
        logMessage("âœ… STOMP ì—°ê²° ì„±ê³µ: " + frame);
      },
      function (error) {
        logMessage("âŒ ì—°ê²° ì‹¤íŒ¨: " + error);
      }
    );

    stompClient2.connect(
      { Authorization: token },
      function (frame) {
        logMessage("âœ… STOMP ì—°ê²° ì„±ê³µ: " + frame);
      },
      function (error) {
        logMessage("âŒ ì—°ê²° ì‹¤íŒ¨: " + error);
      }
    );
  }

  function disconnect() {
    if (stompClient !== null) {
      stompClient.disconnect();
      logMessage("ğŸ”Œ ì—°ê²° ì¢…ë£Œ");
    }
  }

  function subscribe() {
    const documentId = document.getElementById("documentId").value;
    if (!stompClient || !stompClient.connected) {
      logMessage("ğŸš¨ ë¨¼ì € STOMPì— ì—°ê²°í•˜ì„¸ìš”!");
      return;
    }

    subscription = stompClient.subscribe(
      `/sub/document/${documentId}`,
      function (message) {
        logMessage("ğŸ“¨ ë°›ì€ ë©”ì‹œì§€: " + message.body);
      },
      { Authorization: token }
    );

    subscription2 = stompClient.subscribe(
      `/sub/notification/qwe123@naver.com`,
      function (message) {
        logMessage("ğŸ“¨ ë°›ì€ ë©”ì‹œì§€: " + message.body);
      },
      { Authorization: token }
    );

    logMessage(`ğŸ‘€ /sub/document/${documentId} êµ¬ë… ì‹œì‘`);
    logMessage(`ğŸ‘€ /sub/notification/qwe123@naver.com êµ¬ë… ì‹œì‘`);
  }

  function unsubscribe() {
    if (subscription) {
      subscription.unsubscribe();
      logMessage("ğŸš« êµ¬ë… ì·¨ì†Œ ì™„ë£Œ");
    }
  }

  function sendMessage() {
  const documentId = document.getElementById("documentId").value;

  const payload = {
  documentId: documentId,
  message: JSON.stringify({
    documentId: documentId,
    status: "COMPLETED",
    title: "ì„ì‹œ ì œëª©23212",
    content: "ì„ì‹œ ì»¨í…ì¸ 23123",
    logs: [],
    attachments: []
  })
};

  stompClient.send("/pub/editing", { Authorization: token }, JSON.stringify(payload));
  logMessage(`ğŸ“© ë©”ì‹œì§€ ì „ì†¡: ${JSON.stringify(payload)}`);
}
  function loadDocument() {
    const documentId = document.getElementById("documentId").value;

    fetch(`https://docktalk.co.kr/api/document/load?documentId=${documentId}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": token
        }
    })
    .then(response => response.json())
    .then(data => {
    if (data.status === "SUCCESS") {
        const doc = data.data;
        logMessage(`ğŸ“„ ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ: ${JSON.stringify(doc)}`);

        // âœ… ë¶ˆëŸ¬ì˜¨ HTML contentë¥¼ textareaì— ë„£ê¸°
        const editor = document.getElementById("messageInput");
        editor.value = doc.content || "";
    } else {
        logMessage(`âš ï¸ ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${data.message || 'ì˜¤ë¥˜ ë°œìƒ'}`);
    }
})
    .catch(error => {
        logMessage(`âŒ ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: ${error}`);
    });
}
</script>
</body>
</html>