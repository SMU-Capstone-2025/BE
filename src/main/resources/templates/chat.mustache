<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <title>Real-Time Chat</title>
    <style>
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            margin-top: 10px;
        }
        #controls, #room-list, #auth-section {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h2>Real-Time Chat</h2>

<!-- âœ… JWT ì¸ì¦ -->
<div id="auth-section">
    <h3>Enter Your Token</h3>
    <input type="text" id="authToken" placeholder="Enter your JWT token">
    <button id="confirmTokenButton">í™•ì¸</button>
    <p id="displayToken" style="word-break: break-all;"></p>
</div>

<!-- âœ… ì±„íŒ…ë°© ìƒì„± -->
<div>
    <h3>Create Chat Room</h3>
    <input type="text" id="newRoomName" placeholder="Enter room name">
    <button id="createRoomButton">Create Room</button>
</div>

<!-- âœ… ì±„íŒ…ë°© ëª©ë¡ -->
<div id="room-list">
    <h3>Chat Room List</h3>
    <div id="rooms"></div>
</div>
<div>
    <h3>Join Chat Room</h3>
    <input type="text" id="roomIdInput" placeholder="Enter room ID">
    <button id="joinRoomByIdButton">Join Room</button>
</div>
<!-- âœ… ì±„íŒ… ë©”ì‹œì§€ ì…ë ¥ -->
<div id="controls">
    <h3>Chat</h3>
    <input type="text" id="messageInput" placeholder="Enter your message">
    <button id="sendButton" disabled>Send</button>
</div>

<!-- âœ… ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ -->
<div id="messages"></div>

<script>
    let stompClient = null;
    let chatRoomId = null;
    let username = null;

    document.addEventListener("DOMContentLoaded", function () {
        console.log("âœ… [DOMContentLoaded] í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ");

        // âœ… ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.getElementById("createRoomButton").addEventListener("click", function () {
            console.log("âœ… [ë²„íŠ¼ í´ë¦­ë¨] createRoom() ì‹¤í–‰");
            createRoom();
        });

        document.getElementById("confirmTokenButton").addEventListener("click", function () {
            const token = getAuthToken();
            if (!token) {
                alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            console.log("ğŸ”¹ [í™•ì¸ ë²„íŠ¼ í´ë¦­] ì…ë ¥í•œ í† í°:", token);
            document.getElementById('displayToken').textContent = "ğŸ”‘ ì…ë ¥í•œ í† í°: " + token;
            initializeWebSocket();
        });
        document.getElementById("joinRoomByIdButton").addEventListener("click", function () {
            const roomId = document.getElementById('roomIdInput').value;
            if (roomId) {
                joinRoom(roomId);
            } else {
                alert("ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            }
        });
    });

    function getAuthToken() {
        return document.getElementById('authToken').value;
    }

    async function fetchWithAuth(url, options = {}) {
        const token = getAuthToken();
        if (!token) {
            alert('Please enter your token!');
            return;
        }
        console.log("ğŸ”¹ [fetchWithAuth] ìš”ì²­ URL:", url, "í† í°:", token);

        options.headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        try {
            const response = await fetch(url, options);
            console.log("ğŸ”¹ [fetchWithAuth] ì‘ë‹µ ìƒíƒœ:", response.status);
            return response;
        } catch (error) {
            console.error("âŒ [fetchWithAuth] ìš”ì²­ ì‹¤íŒ¨:", error);
        }
    }

    async function createRoom() {
        console.log("âœ… createRoom() í•¨ìˆ˜ ì‹¤í–‰ë¨!");

        const roomName = document.getElementById('newRoomName').value;
        if (!roomName) {
            alert('Please enter a room name!');
            return;
        }

        console.log("ğŸ”¹ [ì±„íŒ…ë°© ìƒì„± ìš”ì²­] Room Name:", roomName);

        try {
            const response = await fetchWithAuth(`/chat/room?name=${encodeURIComponent(roomName)}`, { method: 'POST' });

            if (!response) {
                console.error("âŒ [createRoom] ì‘ë‹µ ì—†ìŒ (fetchWithAuth ì‹¤íŒ¨)");
                return;
            }

            console.log("ğŸ”¹ [ì±„íŒ…ë°© ìƒì„± ì‘ë‹µ ìƒíƒœ] Status:", response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error("âŒ [ì±„íŒ…ë°© ìƒì„± ì˜¤ë¥˜] ì‘ë‹µ ë‚´ìš©:", errorText);
                alert(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                return;
            }

            const room = await response.json();
            console.log("âœ… [ì±„íŒ…ë°© ìƒì„± ì„±ê³µ] ì‘ë‹µ ë°ì´í„°:", room);

            alert(`New chat room created! ID: ${room.roomId}`);
            fetchChatRooms();
        } catch (error) {
            console.error('âŒ [ì±„íŒ…ë°© ìƒì„± ìš”ì²­ ì‹¤íŒ¨]', error);
        }
    }
    function displayMessage(sender, message) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${sender}: ${message}`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function fetchChatHistory(roomId) {
        try {
            const response = await fetch(`/chat/room/${roomId}/history`);
            const messages = await response.json();
            messages.forEach(msg => {
                displayMessage(msg.sender, msg.content);
            });
        } catch (error) {
            console.error('Failed to fetch chat history:', error);
        }
    }

    async function joinRoom(roomId) {
        username = "q";
        chatRoomId = roomId;
        if (!chatRoomId) {
            alert('ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        console.log("ğŸ”¹ [ì±„íŒ…ë°© ì…ì¥] ì±„íŒ…ë°© ID:", chatRoomId);

        if (!stompClient || !stompClient.connected) {
            alert("WebSocketì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const token = getAuthToken();
        if (!token) {
            alert("í† í°ì„ ì…ë ¥í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!");
            return;
        }

        if (stompClient && stompClient.subscriptions && stompClient.subscriptions[chatRoomId]) {
            stompClient.unsubscribe(stompClient.subscriptions[chatRoomId]);
        }

        // âœ… ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
        document.getElementById('messages').innerHTML = '';

        await fetchChatHistory(chatRoomId);

        // âœ… SUBSCRIBE ìš”ì²­ ì‹œ Authorization í—¤ë” í¬í•¨
        const subscription = stompClient.subscribe(
                `/topic/chat/${chatRoomId}`,
                function (message) {
                    const msg = JSON.parse(message.body);
                    displayMessage(msg.sender, msg.content);
                },
                { "Authorization": `Bearer ${token}` }  // âœ… Authorization í—¤ë” ì¶”ê°€
        );

        stompClient.subscriptions = stompClient.subscriptions || {};
        stompClient.subscriptions[chatRoomId] = subscription.id;

        stompClient.send(
                `/app/${chatRoomId}/chat.addUser`,
                { "Authorization": `Bearer ${token}` },  // âœ… Authorization í—¤ë” ì¶”ê°€
                JSON.stringify({
                    sender: username,
                    content: `${username} ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`,
                    type: 'JOIN',
                    roomId: chatRoomId
                })
        );

        alert(`ì±„íŒ…ë°© ${chatRoomId}ì— ì…ì¥í•˜ì˜€ìŠµë‹ˆë‹¤.`);
        document.getElementById('sendButton').disabled = false;
    }




    async function fetchChatRooms() {
        try {
            const response = await fetchWithAuth('/chat/rooms');
            if (!response) {
                console.error("âŒ [fetchChatRooms] ì‘ë‹µ ì—†ìŒ (fetchWithAuth ì‹¤íŒ¨)");
                return;
            }
            const rooms = await response.json();
            console.log("âœ… [ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ ] ê°€ì ¸ì˜¨ ë°©ë“¤:", rooms);

            const roomList = document.getElementById('rooms');
            roomList.innerHTML = '';

            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.textContent = `Room Name: ${room.name}, ID: ${room.roomId}`;
                roomDiv.style.cursor = 'pointer';

                // âœ… í´ë¦­ ì‹œ joinRoom ì‹¤í–‰ (ë¡œê·¸ ì¶”ê°€)
                roomDiv.onclick = function() {
                    console.log(`ğŸ”¹ [ì±„íŒ…ë°© í´ë¦­] ì±„íŒ…ë°© ID: ${room.roomId}`);
                    joinRoom(room.roomId);
                };

                roomList.appendChild(roomDiv);
            });

            console.log("âœ… [fetchChatRooms] ë°© ëª©ë¡ì´ í™”ë©´ì— ì¶”ê°€ë¨.");
        } catch (error) {
            console.error('âŒ [fetchChatRooms] ìš”ì²­ ì‹¤íŒ¨:', error);
        }
    }


    // âœ… ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value.trim();

        if (!messageContent || !chatRoomId) {
            console.warn("âŒ ë©”ì‹œì§€ ë‚´ìš©ì´ ì—†ê±°ë‚˜, ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•ŠìŒ.");
            return;
        }

        if (!stompClient || !stompClient.connected) {
            console.warn("âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ.");
            alert("WebSocketì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const token = getAuthToken();
        if (!token) {
            console.warn("âŒ í† í°ì´ ì—†ìŒ.");
            alert("í† í°ì„ ì…ë ¥í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!");
            return;
        }

        username = "q";

        console.log(`ğŸ”¹ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„: ì±„íŒ…ë°© ${chatRoomId}, ë³´ë‚¸ ì‚¬ëŒ: ${username}, ë‚´ìš©: ${messageContent}`);

        try {
            stompClient.send(
                    `/app/${chatRoomId}/chat.sendMessage`,
                    { "Authorization": `Bearer ${token}` },
                    JSON.stringify({
                        sender: username,
                        content: messageContent,
                        type: 'CHAT',
                        roomId: chatRoomId
                    })
            );
            console.log("âœ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
        } catch (error) {
            console.error("âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", error);
        }

        messageInput.value = '';
    }




    function initializeWebSocket() {
        console.log("ğŸ”¹ [initializeWebSocket] WebSocket ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");

        const token = getAuthToken();
        if (!token) {
            alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        const port = window.location.port || "8081"; // í˜„ì¬ ì ‘ì†ëœ í¬íŠ¸ í™•ì¸, ê¸°ë³¸ê°’ 8081
        const socket = new SockJS(`http://${window.location.hostname}:${port}/chat-websocket`);
        stompClient = Stomp.over(socket);

        // âœ… STOMP connect ì‹œ Authorization í—¤ë” í¬í•¨
        stompClient.connect(
                { "Authorization": `Bearer ${token}` },  // âœ… Authorization í—¤ë” í¬í•¨
                function (frame) {
                    console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ:", frame);

                    fetchChatRooms();  // âœ… ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ 
                },
                function (error) {
                    console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
                }
        );

    }
    window.onload = function () {
        initializeWebSocket();
        fetchChatRooms();

        document.getElementById('createRoomButton').addEventListener('click', createRoom);
        document.getElementById('sendButton').addEventListener('click', sendMessage);
    };


</script>
</body>
</html>
